# Proposal: CSV export of image vulnerability scan data from Harbor

## Abstract

This proposal describes a workflow that can be leveraged to export data provided by third-party scanners with respect to the vulnerability data etc present in one or more images owned by the end user.


# Use Cases

* The user intends to export the vulnerability data from scanners in a format that allows offline downstream analysis
* The exported data should be in a format that is human readable and allows import into downstream analytics tools.

# Scope of the current proposal and implementation

## Functional
* CSV export of vulnerability scan data.
* Allow user to export CSV data by specifying filter criteria
* Allow user to download the exported data.

## Non Functional
* Storage of exported CSV data.
* Clean-up of old CSV export data files.


## Reporting Workflow

CSV reports can be exported by using either one of the following workflows.

1. Login as Registry Admin -> Navigate to Administration -> Click on Reports -> Choose report filter criteria and export
2. Login as normal user -> Navigate to Reports -> Choose report filter criteria and export.
3. Login as registry admin/normal user -> Naviage to projects -> Select a project -> Select an artifact -> Vulnerabilities column shows a link/visual indicator to export.

### Supported Filters
The following filter criteria are proposed for the first release of this feature

* CVE-ID
* Label
* Repository
* Project

The user interface would be responsible for setting the appropriate values for each of these filters as applicable.

## CSV export schema

The CSV export would contain the the following the following structure
```CSV
RowId,Project,Owner,Scanner,CVE,Package,Severity,CVSS V3 Score,CVSS V2 Score,CVSS V3 Vector,CVSS V2 Vector,CWE Ids
1,prahaladd,admin,Trivy,CVE-2019-18276,bash,Low,,,,,CWE-273
2,prahaladd,admin,Trivy,CVE-2019-18276,bash,Low,,,,,CWE-273
3,prahaladd,admin,Trivy,CVE-2019-18276,bash,Low,,,,,CWE-273
```

# Implementation Details

CSV export functionality would expose a non-blocking/asynchronous workflow to generate the CSV reports. It will leverage the existing Harbor Jobservice to execute a CSV data export job. The below sections detail the component interaction for each of the stages of the CSV export workflow.

## Trigger CSV Export Job
The below sequence diagram details the flow and interaction between components when a CSV export is triggered
![Scan Data CSV Export Trigger](../images/scan-result-export/scandataexport_trigger.jpg)

## Check CSV Export Job Status
The below sequence diagram shows the component interaction when the status of a CSV export job is requested
![Scan Data CSV Export Status](../images/scan-result-export/scandataexport_checkstatus.jpg)

## Downlad CSV Data
The below sequence diagram details the component interactions when the user attempts to download a CSV data export file.
![Scan Data CSV Download](../images/scan-result-export/scandataexport_download.jpg)

## Export Job implementation details
A flowchart describing the CSV export job algorithm is shown below

Each CSV export job would create a file with the name `scandata_export_<executionId>.csv` within the folder `/data/scandata_exports`

![Scan result export process](../images/scan-result-export/scandataexport_logic.jpg)

### Intermediate persistence of CSV data
Since, the CSV data is being created during the process of iteration of the query result set, buffering the entire data in memory would be prohibitively expensive. Hence the data would be streamed to an intermediate file within a directory named `scandata_exports` created on a jobservice mounted volume.

The intermediate CSV file would be deleted after the file contents have been pushed to the registry as a system artifact for long term reference and storage.

### Long term storage of CSV export data
The CSV data export job runs within the Jobservice. However, the download request of the CSV data from the UI would be served by the Harbor Core service. In Kubernetes environments, the Jobservice and Harbor Core service would not share volume mounts.
As a result, the Harbor Core service would not have access to the CSV data file generated by the Jobservice when serving the download request.

The generated CSV file is stored as a system data artifact using the facilities provided by the ![System Artifact Manager](https://github.com/goharbor/community/pull/181). 

## Clean-up of CSV data

Generated CSV artifacts are cleaned up using the following mechanisms:

* Post CSV artifact download - The CSV artifact is deleted **after** the process of streaming the CSV artifact to the client completes successfully or with a failure.
* Periodically via the built-in system artifact clean-up job.

## CSV Export functionality API

The next sections provide an overview of the APIs exposed to leverage the CSV data export functionality

### Trigger CSV data export

```
curl --location --request POST 'https://harbordev.com/api/v2.0/export/cve' \
--header 'X-Scan-Data-Type: application/vnd.security.vulnerability.report; version=1.1' \
--header 'Authorization: Basic base64encodedusername:password' \
--header 'Content-Type: application/json' \
--header 'Cookie: sid=94116638f353c520b2ec897b9f06e3ad' \
--data-raw '{
  "cveIds": [
      "CVE-123",
      "CVE-345"
  ],
  "labels": [
    1
  ],
  "repositories": [
      2,
      4,
      6
  ],
  "projects": [
    3
  ]
}'
```
The header parameter `X-Scan-Data-Type` has been introduced to allow for exporting multiple types of scan data that could be supported in the future.
Currently, the CSV export functionality would work only if the header value is `application/vnd.security.vulnerability.report; version=1.1`

The response for this API invocation is shown below. It would contain the execution identifier of the scan data export execution:
```
{
    "id": 7
}
```
### Check status of CSV export job
```
curl --location --request GET 'https://harbordev.com/api/v2.0/export/cve/execution/7' \
--header 'Authorization: Basic base64encodedusername:password' \
--data-raw ''
```
The response from the API is a JSON structure that contains the details about the execution status as shown below
```
{
    "end_time": "2021-11-12T08:52:00.000Z",
    "id": 7,
    "start_time": "2021-11-12T08:51:56.849Z",
    "status": "Success",
    "status_text": "",
    "trigger": "MANUAL",
    "user_id": -1
}
```
### Download the CSV data artifact
```
curl --location --request GET 'https://harbordev.com/api/v2.0/export/cve/download/7' \
--header 'Authorization: Basic cHJhaGFsYWRkOjVkNTRAUHVuMw==' \
--data-raw ''
```
The above API invocation responds with the following important headers
`Content-Type` --> `text/csv`
`Content-Disposition` --> `attachment; filename="scandata_export_7.csv"`